##
# Copyright (c) 2008-2010 Sprymix Inc.
# All rights reserved.
#
# See LICENSE for details.
##


%SCHEMA semantix.caos.datasources.schemas.Sql
%NAME ConceptLink
---
params:
    name:
        type: str

filters:
    - format: dict

source: |
    SELECT
            l.id,
            l.source_id,
            sc.name AS source,
            l.target_id,
            tc.name AS target,
            l.name AS name,
            l.mapping
        FROM
            caos.link l
            INNER JOIN caos.concept sc ON l.source_id = sc.id
            INNER JOIN caos.concept tc ON l.target_id = tc.id
        WHERE
            %(name)s = l.name

...

%SCHEMA semantix.caos.datasources.schemas.Sql
%NAME ConceptLinks
---
params:
    source_concept:
        type: str
        default: !!null
    target_concept:
        type: str
        default: !!null
    name:
        type: str
        default: !!null

filters:
    - format: dict

source: |
    SELECT
            l.id,
            l.source_id,
            sc.name AS source,
            l.target_id,
            tc.name AS target,
            l.name AS name,
            l.mapping,
            l.required,
            l.title,
            l.description,
            l.implicit_derivative,
            l.is_atom,
            l.is_abstract,
            l.readonly
        FROM
            caos.link l
            LEFT JOIN caos.metaobject sc ON l.source_id = sc.id
            LEFT JOIN caos.metaobject tc ON l.target_id = tc.id
        WHERE
            (%(source_concept)s::text IS NULL OR %(source_concept)s::text = sc.name)
            AND (%(target_concept)s::text IS NULL OR %(target_concept)s::text = tc.name)
            AND (%(name)s::text IS NULL OR %(name)s::text = l.name)
        ORDER BY
            l.id, l.target_id NULLS FIRST
