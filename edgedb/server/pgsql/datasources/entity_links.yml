##
# Copyright (c) 2008-2010 Sprymix Inc.
# All rights reserved.
#
# See LICENSE for details.
##


%SCHEMA semantix.datasources.schemas.Sql
%NAME EntityLinks
---
params:
    source_id:
        type: int
    target_id:
        type: int
    source_concepts:
        type: list
    target_concepts:
        type: list
    link_names:
        type: list

filters:
    - format: dict

source: |
    SELECT
            em.source_id AS source_id,
            sc.name AS source_concept,
            em.target_id AS target_id,
            tc.name AS target_concept,
            l.name AS name,
            em.weight AS weight
        FROM
            "caos_semantix.caos.builtins"."link_link" em
            INNER JOIN caos.link l ON em.link_type_id = l.id
            INNER JOIN caos.concept sc ON sc.id = l.source_id
            INNER JOIN caos.concept tc ON tc.id = l.target_id
        WHERE
            (%(source_id)s IS NULL OR em.source_id = %(source_id)s)
            AND (%(target_id)s IS NULL OR em.target_id = %(target_id)s)
            AND (%(source_concepts)s IS NULL OR sc.name = any(%(source_concepts)s))
            AND (%(target_concepts)s IS NULL OR tc.name = any(%(target_concepts)s))
            AND (%(link_names)s IS NULL OR l.name = any(%(link_names)s))
        ORDER BY
            em.weight
