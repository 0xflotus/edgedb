##
# Copyright (c) 2008-2010 Sprymix Inc.
# All rights reserved.
#
# See LICENSE for details.
##


%SCHEMA semantix.caos.datasources.schemas.Sql
%NAME TableInheritance
---
params:
    table_name:
        type: str
    schema_name:
        type: str
        default: "public"
    max_depth:
        type: int
        default: null

source: |
        SELECT
                *
            FROM
                (WITH RECURSIVE inheritance(oid, name, ns, depth, path) AS (
                        SELECT
                                c.oid,
                                c.relname,
                                ns.nspname,
                                0,
                                ARRAY[c.relname]
                            FROM
                                pg_class c
                                INNER JOIN pg_namespace ns ON c.relnamespace = ns.oid
                            WHERE
                                c.relname = %(table_name)s
                                AND ns.nspname = %(schema_name)s
                      UNION ALL
                        SELECT
                                c.oid,
                                c.relname,
                                ns.nspname,
                                i.depth + 1,
                                i.path || c.relname
                            FROM
                                pg_class c,
                                inheritance i,
                                pg_inherits pgi,
                                pg_namespace ns
                            WHERE
                                i.oid = pgi.inhrelid
                                AND c.oid = pgi.inhparent
                                AND ns.oid = c.relnamespace
                                AND (%(max_depth)s::int IS NULL OR i.depth < %(max_depth)s::int)
                )
                SELECT DISTINCT ON (name, ns) name, ns, depth FROM inheritance) q
            ORDER BY
                depth
