##
# Copyright (c) 2008-2010 MagicStack Inc.
# All rights reserved.
#
# See LICENSE for details.
##


%SCHEMA edgedb.server.datasources.schemas.Sql
%NAME ConceptLink
---
params:
    name:
        type: str

filters:
    - format: dict

source: |
    SELECT
            l.id,
            l.source_id,
            sc.name AS source,
            l.target_id,
            tc.name AS target,
            l.name AS name,
            l.mapping
        FROM
            caos.link l
            INNER JOIN caos.concept sc ON l.source_id = sc.id
            INNER JOIN caos.concept tc ON l.target_id = tc.id
        WHERE
            %(name)s = l.name

...

%SCHEMA edgedb.server.datasources.schemas.Sql
%NAME ConceptLinks
---
params:
    source_concept:
        type: str
        default: null

    target_concept:
        type: str
        default: null

    name:
        type: str
        default: null

    include_specialized:
        type: bool
        default: True

filters:
    - format: dict

source: |
    SELECT
            l.id,
            l.source_id,
            sc.name AS source,
            l.target_id,
            tc.name AS target,
            l.spectargets AS spectargets,
            l.name AS name,
            l.base AS base,
            l.mapping,
            l.exposed_behaviour,
            l.required,
            l.title,
            l.description,
            l.is_abstract,
            l.is_final,
            l.readonly,
            l.loading,
            l.constraints,
            l.abstract_constraints,
            l.default
        FROM
            caos.link l
            LEFT JOIN caos.metaobject sc ON l.source_id = sc.id
            LEFT JOIN caos.metaobject tc ON l.target_id = tc.id
        WHERE
            (%(source_concept)s::text IS NULL OR %(source_concept)s::text = sc.name)
            AND (%(target_concept)s::text IS NULL OR %(target_concept)s::text = tc.name)
            AND (%(name)s::text IS NULL OR %(name)s::text = l.name)
            AND (%(include_specialized)s::bool OR l.source_id IS NULL)
        ORDER BY
            l.id, l.target_id NULLS FIRST
...

%SCHEMA edgedb.server.datasources.schemas.Sql
%NAME LinkProperties
---
params:
    source:
        type: str
        default: null

    target:
        type: str
        default: null

    name:
        type: str
        default: null

    include_specialized:
        type: bool
        default: True

filters:
    - format: dict

source: |
    SELECT
            p.id            AS id,
            p.name          AS name,
            p.base          AS base,
            p.title         AS title,
            p.description   AS description,
            p.required      AS required,
            p.readonly      AS readonly,
            p.loading       AS loading,
            p.default       AS default,
            p.source_id     AS source_id,
            p.target_id     AS target_id,
            p.constraints   AS constraints,
            p.abstract_constraints AS abstract_constraints,
            l.name          AS source,
            a.name          AS target
        FROM
            caos.link_property p
            LEFT JOIN caos.link l ON l.id = p.source_id
            LEFT JOIN caos.metaobject a ON a.id = p.target_id
        WHERE
            (%(source)s::text IS NULL OR %(source)s::text = l.name)
            AND (%(target)s::text IS NULL OR %(target)s::text = a.name)
            AND (%(name)s::text IS NULL OR %(name)s::text = p.name)
            AND (%(include_specialized)s::bool OR p.source_id IS NULL)
        ORDER BY
            p.id, p.target_id NULLS FIRST

...

%SCHEMA edgedb.server.datasources.schemas.Sql
%NAME Computables
---
params:
    source:
        type: str
        default: null

    name:
        type: str
        default: null

filters:
    - format: dict

source: |
    SELECT
            p.id            AS id,
            p.name          AS name,
            p.title         AS title,
            p.description   AS description,
            p.source_id     AS source_id,
            p.target_id     AS target_id,
            s.name          AS source,
            t.name          AS target,
            p.expression    AS expression,
            p.is_local      AS is_local
        FROM
            caos.computable p
            LEFT JOIN caos.metaobject s ON s.id = p.source_id
            LEFT JOIN caos.metaobject t ON t.id = p.target_id
        WHERE
            (%(source)s::text IS NULL OR %(source)s::text = s.name)
            AND (%(name)s::text IS NULL OR %(name)s::text = p.name)
        ORDER BY
            p.id, p.target_id NULLS FIRST
