##
# Copyright (c) 2008-2010 Sprymix Inc.
# All rights reserved.
#
# See LICENSE for details.
##


%SCHEMA metamagic.utils.lang.yaml.schema.ModuleSchema
%NAME Semantics
---
type: map
object: metamagic.caos.backends.yaml.ProtoSchemaAdapter
mapping:
    "module":
        type: str
        required: no

    "backend":
        type: str
        required: no
        default: "data"

    "attributes":
        type: map
        default: {}
        mapping:
            =: # name of an attribute
                type: map
                object: metamagic.caos.backends.yaml.Attribute
                required: yes
                mapping:
                    "title": &TEXT_WITH_GRAM_CATEGORIES
                        type: choice
                        object: metamagic.caos.backends.yaml.WordCombination
                        choice:
                            - type: str
                            - type: map
                              mapping:
                                =:
                                    type: str

                    "description":
                        type: str

                    "type":
                        type: choice
                        object: metamagic.caos.backends.yaml.SchemaType
                        choice:
                            - type: str
                            - type: map
                              mapping:
                                  =:
                                      type: map
                                      mapping:
                                          constraints:
                                              type: multimap
                                              object: metamagic.caos.backends.yaml.SchemaTypeConstraintSet
                                              mapping:
                                                    =:
                                                          type: any

    "atoms":
        type: map
        default: {}
        mapping:
            =: # name of an atom
                type: map
                object: metamagic.caos.backends.yaml.Atom
                required: yes
                mapping:
                    "title":
                        *TEXT_WITH_GRAM_CATEGORIES

                    "description":
                        type: str

                    "extends":
                        type: choice
                        required: yes
                        choice:
                            - type: str
                            - type: seq
                              sequence:
                                - type: str

                    "abstract":
                        type: bool
                        default: null

                    "final":
                        type: bool
                        default: null

                    "default": &DEFAULT
                        type: choice
                        choice:
                            - &DEFAULT_ITEM
                              type: choice
                              choice:
                                - type: scalar
                                  object: metamagic.caos.backends.yaml.LiteralDefaultSpec
                                  required: true

                                - type: map
                                  object: metamagic.caos.backends.yaml.QueryDefaultSpec
                                  max-length: 1
                                  min-length: 1
                                  mapping:
                                    "query":
                                        type: str
                                        required: true

                            - type: seq
                              sequence:
                                - *DEFAULT_ITEM

                    "attributes":
                        type: map
                        mapping:
                            =:
                                type: any
                                object: metamagic.caos.backends.yaml.AttributeValue

                    "constraints": &ATOM_CONSTRAINTS
                        type: seq
                        sequence:
                          - type: choice
                            choice:
                                - type: map
                                  object: metamagic.caos.backends.yaml.AtomConstraintMaxLength
                                  max-length: 1
                                  min-length: 1
                                  mapping:
                                    "max-length":
                                        type: int
                                - type: map
                                  object: metamagic.caos.backends.yaml.AtomConstraintMaxValue
                                  max-length: 1
                                  min-length: 1
                                  mapping:
                                    "max-value":
                                        type: any
                                - type: map
                                  object: metamagic.caos.backends.yaml.AtomConstraintMaxExValue
                                  max-length: 1
                                  min-length: 1
                                  mapping:
                                    "max-value-ex":
                                        type: any
                                - type: map
                                  object: metamagic.caos.backends.yaml.AtomConstraintMinLength
                                  max-length: 1
                                  min-length: 1
                                  mapping:
                                    "min-length":
                                        type: int
                                - type: map
                                  object: metamagic.caos.backends.yaml.AtomConstraintMinValue
                                  max-length: 1
                                  min-length: 1
                                  mapping:
                                    "min-value":
                                        type: any
                                - type: map
                                  object: metamagic.caos.backends.yaml.AtomConstraintMinExValue
                                  max-length: 1
                                  min-length: 1
                                  mapping:
                                    "min-value-ex":
                                        type: any
                                - type: map
                                  object: metamagic.caos.backends.yaml.AtomConstraintRegExp
                                  max-length: 1
                                  min-length: 1
                                  mapping:
                                    "regexp":
                                        type: str
                                - type: map
                                  object: metamagic.caos.backends.yaml.AtomConstraintExpr
                                  max-length: 1
                                  min-length: 1
                                  mapping:
                                    "expr":
                                        type: str
                                - type: map
                                  object: metamagic.caos.backends.yaml.AtomConstraintEnum
                                  max-length: 1
                                  min-length: 1
                                  mapping:
                                    "enum":
                                        type: seq
                                        sequence:
                                            - type: scalar

    "link-properties":
        type: map
        default: {}
        mapping:
            =: # name of a link property
                type: map
                object: metamagic.caos.backends.yaml.LinkPropertyDef
                required: yes
                mapping:
                    "title":
                        *TEXT_WITH_GRAM_CATEGORIES

                    "description":
                        type: str

                    "readonly":
                        type: bool

                    "required":
                        type: bool

                    "loading":
                        &POINTER_LOADING
                        type: str
                        object: metamagic.caos.backends.yaml.PointerLoading
                        enum: [lazy, eager]

                    "extends":
                        type: choice
                        default:
                        choice:
                            - type: str
                            - type: seq
                              sequence:
                                - type: str

    "cascade-actions":
        type: map
        default: {}
        mapping:
            =: # name of a cascade action
                type: map
                object: metamagic.caos.backends.yaml.PointerCascadeAction
                required: yes
                mapping:
                    "title":
                        *TEXT_WITH_GRAM_CATEGORIES

                    "description":
                        type: str

    "cascade-events":
        type: map
        default: {}
        mapping:
            =: # name of a cascade event
                type: map
                object: metamagic.caos.backends.yaml.PointerCascadeEvent
                required: yes
                mapping:
                    "title":
                        *TEXT_WITH_GRAM_CATEGORIES

                    "description":
                        type: str

                    "extends":
                        type: str

                    "allowed-actions":
                        type: choice
                        required: yes
                        object: metamagic.caos.backends.yaml.PointerCascadeActionSet
                        choice:
                            - type: str
                            - type: seq
                              sequence:
                                - type: str

    "links":
        type: map
        default: {}
        mapping:
            =: # name of a link
                type: map
                object: metamagic.caos.backends.yaml.LinkDef
                required: yes
                mapping:
                    "title": *TEXT_WITH_GRAM_CATEGORIES

                    "description":
                        type: str

                    "extends":
                        type: choice
                        default:
                        choice:
                            - type: str
                            - type: seq
                              sequence:
                                - type: str

                    "abstract":
                        type: bool

                    "final":
                        type: bool
                        default: null

                    "readonly":
                        type: bool

                    "loading":
                        *POINTER_LOADING

                    "required":
                        type: bool

                    "default":
                        *DEFAULT

                    "mapping": &LINK_MAPPING
                        type: str
                        object: metamagic.caos.backends.yaml.LinkMapping
                        enum: ["1*", "11", "**", "*1"]
                        default: null

                    "exposed_behaviour": &LINK_EXPOSED_BEHAVIOUR
                        type: str
                        object: metamagic.caos.backends.yaml.LinkExposedBehaviour
                        enum: ["first-item", "set"]
                        default: null

                    "cascades": &CASCADES
                        type: map
                        mapping:
                            =:
                                type: choice
                                choice:
                                    - type: str
                                    - type: map
                                      mapping:
                                        =:
                                            type: str

                    "properties":
                        type: map
                        default: {}
                        mapping:
                            =:
                                type: choice
                                object: metamagic.caos.backends.yaml.LinkProperty
                                choice:
                                    - type: str
                                    - type: map
                                      max-length: 1
                                      min-length: 1
                                      mapping:
                                        =:
                                            type: map
                                            mapping:
                                                "title":
                                                    *TEXT_WITH_GRAM_CATEGORIES
                                                "description":
                                                    type: str
                                                "required":
                                                    type: bool
                                                "readonly":
                                                    type: bool
                                                "loading":
                                                    *POINTER_LOADING
                                                "constraints":
                                                    type: choice
                                                    choice:
                                                       - *ATOM_CONSTRAINTS
                                                       - &POINTER_CONSTRAINTS
                                                         type: seq
                                                         sequence:
                                                           - type: choice
                                                             choice:
                                                               - type: map
                                                                 max-length: 1
                                                                 min-length: 1
                                                                 object: metamagic.caos.backends.yaml.PointerConstraintUnique
                                                                 mapping:
                                                                   "unique":
                                                                       type: choice
                                                                       required: True
                                                                       choice:
                                                                           - type: bool
                                                                           - type: str

                                                "abstract-constraints":
                                                    *POINTER_CONSTRAINTS

                                                "default":
                                                    *DEFAULT

                    "computables":
                        &COMPUTABLES
                        type: map
                        ordered: True
                        default: {}
                        mapping:
                            =:
                                type: choice
                                required: yes
                                object: metamagic.caos.backends.yaml.Computable
                                choice:
                                    - type: str
                                    - type: map
                                      mapping:
                                        "title":
                                            *TEXT_WITH_GRAM_CATEGORIES
                                        "description":
                                            type: str
                                        "expression":
                                            type: str
                                        "mapping":
                                            *LINK_MAPPING
                                        "exposed_behaviour":
                                            *LINK_EXPOSED_BEHAVIOUR

                    "indexes":
                        &INDEXES
                        type: seq
                        sequence:
                            - type: str
                              object: metamagic.caos.backends.yaml.SourceIndex


    "concepts":
        type: map
        default: {}
        mapping:
            =:
                type: map
                object: metamagic.caos.backends.yaml.Concept
                mapping:
                    "title":
                        *TEXT_WITH_GRAM_CATEGORIES

                    "abstract":
                        type: bool
                        default: null

                    "final":
                        type: bool
                        default: null

                    "description":
                        type: str

                    "extends":
                        type: choice
                        default:
                        choice:
                            - type: str
                            - type: seq
                              sequence:
                                - type: str

                    "links":
                        type: map
                        default: {}
                        mapping:
                            =:
                                type: map
                                object: metamagic.caos.backends.yaml.SpecializedLink
                                type: choice
                                required: yes
                                choice:
                                  - type: str
                                  - type: seq
                                    sequence:
                                        - type: str
                                  - type: map
                                    max-length: 1
                                    min-length: 1
                                    mapping:
                                        =:
                                            type: map
                                            mapping:
                                              "title":
                                                  *TEXT_WITH_GRAM_CATEGORIES
                                              "description":
                                                  type: str
                                              "required":
                                                  type: bool
                                                  default: null
                                              "readonly":
                                                  type: bool
                                                  default: null
                                              "loading":
                                                  *POINTER_LOADING
                                              "mapping":
                                                  *LINK_MAPPING
                                              "exposed_behaviour":
                                                  *LINK_EXPOSED_BEHAVIOUR
                                              "constraints":
                                                  type: choice
                                                  choice:
                                                    - *ATOM_CONSTRAINTS
                                                    - *POINTER_CONSTRAINTS
                                              "abstract-constraints":
                                                  *POINTER_CONSTRAINTS
                                              "cascades":
                                                  *CASCADES
                                              "comparison":
                                                  type: str
                                                  enum: [cidirect, fuzzy]
                                              "default":
                                                  *DEFAULT
                                              "properties":
                                                  type: map
                                                  mapping:
                                                    =: # property name
                                                        object: metamagic.caos.backends.yaml.LinkPropertyProps
                                                        type: map
                                                        mapping:
                                                            "default":
                                                                *DEFAULT
                                              "search":
                                                  type: choice
                                                  object: metamagic.caos.backends.yaml.LinkSearchConfiguration
                                                  choice:
                                                    - type: map
                                                      mapping:
                                                         "weight":
                                                            type: str
                                                            object: metamagic.caos.backends.yaml.LinkSearchWeight
                                                            enum: ['A', 'B', 'C', 'D']
                                                            required: True
                                                    - type: bool

                    "computables":
                        *COMPUTABLES

                    "indexes":
                        *INDEXES

                    "heuristics":
                        type: map
                        mapping:
                            "comparison":
                                type: seq
                                sequence:
                                    -
                                        type: map
                                        mapping:
                                            "link":
                                                type: str

                                            "attribute":
                                                type: str

                                            "weight":
                                                type: float
                                                range: {min: 0.0, max: 1.0}
                                                required: yes

    "policies":
        type: map
        mapping:
            "links":
                type: map
                default: {}
                mapping:
                    =:
                        type: map
                        mapping:
                            "cascades":
                                *CASCADES

            "concepts":
                type: map
                default: {}
                mapping:
                    =:
                        type: map
                        mapping:
                            "links":
                                type: map
                                default: {}
                                mapping:
                                    =:
                                        type: map
                                        mapping:
                                            "cascades":
                                                *CASCADES
